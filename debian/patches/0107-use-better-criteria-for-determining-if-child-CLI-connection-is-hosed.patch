From b69fff3f3404ac8800d74657c7d3e2c04bf54eeb Mon Sep 17 00:00:00 2001
From: Poul-Henning Kamp <phk@FreeBSD.org>
Date: Sun, 13 Nov 2011 22:02:44 +0000
Subject: [PATCH] Use better criteria for determining if child CLI connection
 is hosed.

Backports commit 2144dc78 for Varnish 3.0.6 (by Geoff)
---
 bin/varnishd/mgt_cli.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/bin/varnishd/mgt_cli.c b/bin/varnishd/mgt_cli.c
index 7b27e98..da22660 100644
--- a/bin/varnishd/mgt_cli.c
+++ b/bin/varnishd/mgt_cli.c
@@ -172,7 +172,8 @@ mcf_askchild(struct cli *cli, const char * const *av, void *priv)
 		return;
 	}
 	VSB_delete(vsb);
-	(void)VCLI_ReadResult(cli_i, &u, &q, params->cli_timeout);
+	if (VCLI_ReadResult(cli_i, &u, &q, params->cli_timeout))
+		MGT_Child_Cli_Fail();
 	VCLI_SetResult(cli, u);
 	VCLI_Out(cli, "%s", q);
 	free(q);
@@ -221,11 +222,10 @@ mgt_cli_askchild(unsigned *status, char **resp, const char *fmt, ...) {
 		return (CLIS_COMMS);
 	}
 
-	(void)VCLI_ReadResult(cli_i, &u, resp, params->cli_timeout);
+	if (VCLI_ReadResult(cli_i, &u, resp, params->cli_timeout))
+		MGT_Child_Cli_Fail();
 	if (status != NULL)
 		*status = u;
-	if (u == CLIS_COMMS)
-		MGT_Child_Cli_Fail();
 	return (u == CLIS_OK ? 0 : u);
 }
 
